name: ðŸŽ¯ Consumer-Grade CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: false
        default: 'standard'
        type: choice
        options:
        - standard
        - full
        - quick

env:
  NODE_VERSION: '20.x'
  TIMEOUT_MINUTES: 30

jobs:
  # ðŸ§ª Consumer-Grade Testing
  consumer-grade-tests:
    name: ðŸŽ¯ Consumer-Grade Quality Tests
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [18.x, 20.x, 22.x]
        include:
          - os: ubuntu-latest
            node-version: 20.x
            primary: true
    
    timeout-minutes: 30
    
    steps:
    - name: ðŸŽ¯ Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for better analysis
        
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci --prefer-offline --no-audit
        npm install -g mcp-proxy --silent
        
    - name: ðŸ”§ Install System Dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -q
        sudo apt-get install -y -q ripgrep curl lsof
        
    - name: ðŸ”§ Install System Dependencies (macOS)  
      if: runner.os == 'macOS'
      run: |
        brew install ripgrep curl
        
    - name: ðŸŽ­ Install Browser Dependencies
      if: matrix.primary
      run: |
        npx playwright install chromium --quiet
        
    - name: ðŸ§ª Run Consumer-Grade Test Suite
      run: |
        chmod +x test/consumer-grade-test-suite.sh
        if [ "${{ github.event.inputs.test_mode }}" = "full" ]; then
          ./test/consumer-grade-test-suite.sh --full
        else
          ./test/consumer-grade-test-suite.sh
        fi
        
    - name: ðŸ“Š Collect Test Artifacts
      if: always()
      run: |
        # Create comprehensive artifact structure
        mkdir -p artifacts/reports artifacts/logs artifacts/coverage
        
        # Copy test reports
        cp -r test/reports/* artifacts/reports/ 2>/dev/null || true
        
        # Copy test logs  
        cp -r /tmp/acf-consumer-tests/* artifacts/logs/ 2>/dev/null || true
        
        # Generate system info
        echo "## System Information" > artifacts/system-info.md
        echo "- **OS**: ${{ runner.os }}" >> artifacts/system-info.md
        echo "- **Node.js**: $(node --version)" >> artifacts/system-info.md
        echo "- **npm**: $(npm --version)" >> artifacts/system-info.md
        echo "- **Timestamp**: $(date -u)" >> artifacts/system-info.md
        
    - name: ðŸ“‹ Upload Test Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: consumer-grade-tests-${{ matrix.os }}-node${{ matrix.node-version }}
        path: artifacts/
        retention-days: 14
        compression-level: 6
        
    - name: ðŸ“ˆ Update Job Summary (Primary)
      if: always() && matrix.primary
      run: |
        echo "## ðŸŽ¯ Consumer-Grade Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "test/reports/consumer-grade-report.md" ]; then
          cat test/reports/consumer-grade-report.md >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Test report not generated" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ github.job }})" >> $GITHUB_STEP_SUMMARY

  # ðŸ”’ Security & Quality Gates
  security-quality:
    name: ðŸ”’ Security & Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸŽ¯ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: ðŸ›¡ï¸ Security Audit
      run: |
        echo "## ðŸ”’ Security Audit Results" >> $GITHUB_STEP_SUMMARY
        
        # Run audit with different severity levels
        if npm audit --audit-level=critical --json > audit-critical.json 2>/dev/null; then
          echo "âœ… **No critical vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Critical vulnerabilities detected**" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=critical >> $GITHUB_STEP_SUMMARY || true
        fi
        
        if npm audit --audit-level=high --json > audit-high.json 2>/dev/null; then
          echo "âœ… **No high-severity vulnerabilities**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **High-severity vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-extended,security-and-quality
        
    - name: ðŸ”Ž Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        upload: true
        
    - name: ðŸ“Š Package Analysis
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Package Analysis" >> $GITHUB_STEP_SUMMARY
        
        # Check package.json structure
        if jq -e '.scripts.test' package.json >/dev/null; then
          echo "âœ… Test scripts defined" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No test scripts found" >> $GITHUB_STEP_SUMMARY
        fi
        
        if jq -e '.engines.node' package.json >/dev/null; then
          echo "âœ… Node.js version constraints defined" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No Node.js version constraints" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for common files
        [ -f "README.md" ] && echo "âœ… README.md present" >> $GITHUB_STEP_SUMMARY
        [ -f "LICENSE" ] && echo "âœ… LICENSE present" >> $GITHUB_STEP_SUMMARY
        [ -f ".gitignore" ] && echo "âœ… .gitignore present" >> $GITHUB_STEP_SUMMARY

  # ðŸš€ Deployment Readiness
  deployment-readiness:
    name: ðŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [consumer-grade-tests, security-quality]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ðŸŽ¯ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: ðŸ³ Docker Build Test
      run: |
        echo "## ðŸ³ Docker Build Verification" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "Dockerfile.proxy" ]; then
          echo "ðŸ³ Building Docker image..." >> $GITHUB_STEP_SUMMARY
          
          if docker build -f Dockerfile.proxy -t acf-test:${{ github.sha }} .; then
            echo "âœ… **Docker build successful**" >> $GITHUB_STEP_SUMMARY
            
            # Test container startup
            if docker run --rm -d --name acf-test-run -p 9080:8080 acf-test:${{ github.sha }}; then
              sleep 10
              
              if curl -f http://localhost:9080/health >/dev/null 2>&1; then
                echo "âœ… **Container health check passed**" >> $GITHUB_STEP_SUMMARY
              else
                echo "âš ï¸ **Container health check failed**" >> $GITHUB_STEP_SUMMARY
              fi
              
              docker stop acf-test-run 2>/dev/null || true
            fi
            
            # Clean up
            docker rmi acf-test:${{ github.sha }} 2>/dev/null || true
          else
            echo "âŒ **Docker build failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        else
          echo "âš ï¸ **No Dockerfile.proxy found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“‹ Environment Check
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŒ Environment Compatibility" >> $GITHUB_STEP_SUMMARY
        
        # Check Node.js compatibility
        node_version=$(node --version)
        echo "âœ… **Node.js**: $node_version" >> $GITHUB_STEP_SUMMARY
        
        # Check npm compatibility  
        npm_version=$(npm --version)
        echo "âœ… **npm**: $npm_version" >> $GITHUB_STEP_SUMMARY
        
        # Check essential commands
        commands=("curl" "grep" "awk" "sed")
        for cmd in "${commands[@]}"; do
          if command -v "$cmd" >/dev/null 2>&1; then
            echo "âœ… **$cmd**: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **$cmd**: Missing" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
    - name: ðŸŽ‰ Deployment Ready
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Consumer-grade tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security analysis completed" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Docker build verified" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Environment compatibility confirmed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Ready for Production Deployment!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ðŸ“¢ Quality Report  
  quality-report:
    name: ðŸ“¢ Quality Report & Notification
    runs-on: ubuntu-latest
    needs: [consumer-grade-tests, security-quality, deployment-readiness]
    if: always()
    
    steps:
    - name: ðŸ“Š Calculate Overall Status
      id: status
      run: |
        tests_result="${{ needs.consumer-grade-tests.result }}"
        security_result="${{ needs.security-quality.result }}"
        deployment_result="${{ needs.deployment-readiness.result }}"
        
        if [ "$tests_result" = "success" ] && [ "$security_result" = "success" ]; then
          if [ "$deployment_result" = "success" ] || [ "$deployment_result" = "skipped" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "quality=CONSUMER_GRADE" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT  
            echo "quality=NEAR_CONSUMER_GRADE" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "quality=NEEDS_IMPROVEMENT" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸŽ¯ Generate Quality Report
      run: |
        echo "# ðŸŽ¯ ACF Consumer-Grade Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        case "${{ steps.status.outputs.quality }}" in
          "CONSUMER_GRADE")
            echo "## ðŸŽ‰ CONSUMER-GRADE QUALITY ACHIEVED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All tests passed with consumer-grade standards" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Security analysis completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Deployment readiness confirmed" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Ready for production use" >> $GITHUB_STEP_SUMMARY
            ;;
          "NEAR_CONSUMER_GRADE") 
            echo "## âš ï¸ NEAR CONSUMER-GRADE QUALITY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Core functionality meets consumer standards" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Minor deployment or infrastructure issues" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”§ Review deployment readiness results" >> $GITHUB_STEP_SUMMARY
            ;;
          "NEEDS_IMPROVEMENT")
            echo "## âŒ QUALITY IMPROVEMENT NEEDED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Test failures or security issues detected" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”§ Address failing tests before deployment" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Review security analysis results" >> $GITHUB_STEP_SUMMARY
            ;;
        esac
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Consumer-Grade Tests | ${{ needs.consumer-grade-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security & Quality | ${{ needs.security-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment Readiness | ${{ needs.deployment-readiness.result == 'success' && 'âœ… Passed' || needs.deployment-readiness.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸš¨ Notify on Quality Issues
      if: steps.status.outputs.status != 'success'
      run: |
        echo "::warning title=Quality Issues Detected::Consumer-grade quality standards not fully met. Review the pipeline results above."
        
    - name: ðŸŽ‰ Celebrate Success
      if: steps.status.outputs.status == 'success'
      run: |
        echo "::notice title=Consumer-Grade Quality Achieved::ðŸŽ‰ All quality gates passed! ACF is ready for production deployment." 