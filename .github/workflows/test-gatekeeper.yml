name: ðŸ§ª ACF Test Gatekeeper

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-gatekeeper:
    name: ðŸ›¡ï¸ Test Gatekeeper
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v3
      
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g mcp-proxy
        
    - name: ðŸ”§ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ripgrep curl
        
    - name: ðŸŽ­ Install Playwright
      run: |
        npx playwright install chromium
        
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "ðŸ§ª Running Unit Tests..."
        node test/unit/test-simple-tools.js
        
    - name: ðŸ”— Run Integration Tests
      run: |
        echo "ðŸ”— Running Integration Tests..."
        bash test/integration/test-all-tools-comprehensive.sh
        
    - name: ðŸ—ï¸ Run Core Functionality Tests
      run: |
        echo "ðŸ—ï¸ Running Core Tests..."
        node test/comprehensive_mcp_test.js
        node test/test_env_guardrails.js
        node test/test_filesystem.js
        
    - name: ðŸš€ Run MCP Proxy Tests
      run: |
        echo "ðŸš€ Running MCP Proxy Tests..."
        bash test/integration/test-mcp-proxy.sh
        
    - name: ðŸ”„ Run MCP Client Tests
      run: |
        echo "ðŸ”„ Running MCP Client Tests..."
        bash test/integration/test-mcp-clients.sh
        
    - name: ðŸŒ Run MCP Proxy Integration Tests
      run: |
        echo "ðŸŒ Running MCP Proxy Integration Tests..."
        bash test/integration/test-mcp-proxy-integration.sh
        
    - name: ðŸ“Š Run Comprehensive Test Suite
      run: |
        echo "ðŸ“Š Running Comprehensive Test Suite..."
        chmod +x test/run-all-tests.sh
        ./test/run-all-tests.sh
        
    - name: ðŸ“‹ Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-node-${{ matrix.node-version }}
        path: |
          test/reports/
          /tmp/acf_test_*.log
        retention-days: 30
        
    - name: ðŸ“ˆ Generate Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js Version:** ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Test Environment:** Ubuntu Latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "test/reports/comprehensive-test-results.md" ]; then
          echo "### ðŸ“Š Comprehensive Test Results" >> $GITHUB_STEP_SUMMARY
          cat test/reports/comprehensive-test-results.md >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "test/reports/SIMPLE-TEST-REPORT.md" ]; then
          echo "### ðŸ”§ Unit Test Results" >> $GITHUB_STEP_SUMMARY
          cat test/reports/SIMPLE-TEST-REPORT.md >> $GITHUB_STEP_SUMMARY
        fi

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ðŸ” Run npm audit
      run: |
        npm audit --audit-level=moderate
        
    - name: ðŸ›¡ï¸ Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: ðŸ”Ž Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  deployment-readiness:
    name: ðŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [test-gatekeeper, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ðŸ³ Test Docker Build
      run: |
        if [ -f "Dockerfile.proxy" ]; then
          echo "ðŸ³ Testing Docker build..."
          docker build -f Dockerfile.proxy -t acf-test .
          echo "âœ… Docker build successful"
        else
          echo "âš ï¸ No Dockerfile.proxy found, skipping Docker test"
        fi
        
    - name: ðŸ“‹ Generate Deployment Report
      run: |
        echo "## ðŸš€ Deployment Readiness Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Readiness Checklist" >> $GITHUB_STEP_SUMMARY
        echo "- [x] All tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Security scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Docker build verified" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Ready for deployment" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸŽ‰ Deployment Ready
      run: |
        echo "ðŸŽ‰ All checks passed! ACF is ready for deployment."
        echo "âœ… Tests: PASSED"
        echo "âœ… Security: PASSED" 
        echo "âœ… Build: PASSED"
        echo "ðŸš€ Ready to deploy to production!"

  notify-status:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [test-gatekeeper, security-scan, deployment-readiness]
    if: always()
    
    steps:
    - name: ðŸ“Š Calculate Overall Status
      id: status
      run: |
        if [ "${{ needs.test-gatekeeper.result }}" = "success" ] && \
           [ "${{ needs.security-scan.result }}" = "success" ] && \
           [ "${{ needs.deployment-readiness.result }}" = "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ðŸŽ‰ All checks passed! ACF is production ready." >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ Some checks failed. Review the logs for details." >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ“¢ Post Status Summary
      run: |
        echo "## ðŸ›¡ï¸ Gatekeeper Status Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Overall Status:** ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Message:** ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Gatekeeper:** ${{ needs.test-gatekeeper.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scan:** ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Readiness:** ${{ needs.deployment-readiness.result }}" >> $GITHUB_STEP_SUMMARY 